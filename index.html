<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Results Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        .fade-enter-active { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }

        /* Faculty Table */
        .fac-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .fac-table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; }
        .fac-table th { background: #f1f5f9; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 0.65rem; padding: 10px 12px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; z-index: 10; letter-spacing: 0.05em; }
        .fac-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; vertical-align: middle; }
        .fac-table tr:hover { background-color: #f8fafc; }
        
        .status-dot { font-size: 1.2rem; line-height: 0; position: relative; top: 3px; margin-right: 2px; }
        .status-green { color: #10b981; }
        .status-gray { color: #cbd5e1; }
        
        .low-mark { color: #dc2626; font-weight: 800; } /* Red color for low marks */

        /* Common */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); }
        .dash-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); border: 1px solid #f1f5f9; transition: transform 0.2s; }
        .dash-card:active { transform: scale(0.98); }
        .input-bubble { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; text-align: center; font-weight: 700; font-size: 1.1rem; color: #334155; transition: all 0.2s; outline: none; }
        .input-bubble:focus { background: white; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .select2-container .select2-selection--single { height: 52px !important; padding: 12px !important; border-radius: 12px !important; border: 1px solid #e2e8f0 !important; background-color: #f8fafc !important; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { top: 14px !important; }
        .mark-ab { color: #ef4444; background: #fef2f2; padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 0.9em; }
        .error-border { border-color: #ef4444 !important; background-color: #fff5f5 !important; }
        .part-a-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 99px; background: #eff6ff; color: #3b82f6; font-weight: 600; margin-top: 4px; display: inline-block; }
        .part-a-excluded { background: #f3f4f6; color: #9ca3af; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- 1. LOGIN SCREEN -->
    <div id="viewLogin" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md glass-panel p-6 rounded-3xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Portal Login</h1>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-slate-100 mb-6">
                <button class="flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600" id="tabStudent" onclick="switchTab('student')">Student</button>
                <button class="flex-1 pb-3 text-sm font-bold text-slate-400" id="tabFaculty" onclick="switchTab('faculty')">Faculty</button>
            </div>

            <!-- STUDENT FORM -->
            <form id="formStudent" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div class="bg-slate-50 p-1.5 rounded-2xl flex">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="loginDept" value="CSE" checked class="peer sr-only" onchange="populateUSN()">
                            <div class="py-2.5 rounded-xl text-center text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-slate-900 peer-checked:shadow-sm">CSE</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="loginDept" value="ISE" class="peer sr-only" onchange="populateUSN()">
                            <div class="py-2.5 rounded-xl text-center text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-slate-900 peer-checked:shadow-sm">ISE</div>
                        </label>
                    </div>
                    <select id="loginUSN" class="w-full" required disabled><option value="">Select Department...</option></select>
                    <input type="text" id="loginDOB" placeholder="DOB (DD-MM-YYYY)" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 text-center font-mono placeholder:text-slate-300 outline-none focus:border-slate-900" required>
                    <button type="submit" id="btnLogin" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition-all">View Results</button>
                </div>
            </form>

            <!-- FACULTY FORM -->
            <form id="formFaculty" class="hidden space-y-4" onsubmit="handleFacultyLogin(event)">
                <input type="text" id="facUser" placeholder="Username" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 outline-none focus:border-blue-600" required>
                <input type="password" id="facPass" placeholder="Password" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 outline-none focus:border-blue-600" required>
                <button type="submit" id="btnFacLogin" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-all">Access Dashboard</button>
            </form>
        </div>
    </div>

    <!-- 2. FACULTY DASHBOARD (Consolidated View) -->
    <div id="viewFacultyDash" class="hidden-section min-h-screen bg-slate-50 pb-10">
        <div class="bg-blue-600 px-6 py-5 sticky top-0 z-30 shadow-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center text-white">
                <div>
                    <h2 class="text-xl font-bold">Consolidated Marks</h2>
                    <p class="text-xs text-blue-200">Weightage Calculation</p>
                </div>
                <div class="flex items-center gap-4">
                    <select id="facDeptSelect" onchange="loadBatchData()" class="bg-blue-700 text-white border-none rounded-lg text-sm font-bold px-3 py-1.5 outline-none">
                        <!-- Options populated dynamically based on access -->
                    </select>
                    <button onclick="logout()" class="text-blue-200 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>

        <div class="max-w-[95%] mx-auto px-2 py-6">
            <div class="fac-container">
                <table class="fac-table">
                    <thead>
                        <tr>
                            <th class="w-10">#</th>
                            <th>Reg. No</th>
                            <th>Name</th>
                            <th>IA 1</th>
                            <th>IA 2</th>
                            <th>Avg IA (50)</th>
                            <th>Avg (20)</th>
                            <th>OA (Proj)</th>
                            <th>Lab (10)</th>
                            <th>CP (5)</th>
                            <th>Total (40)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="facTableBody">
                        <tr><td colspan="12" class="text-center text-slate-400 py-8">Loading Data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. STUDENT DASHBOARD -->
    <div id="viewDashboard" class="hidden-section min-h-screen pb-10">
        <div class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-4 flex justify-between items-center shadow-sm">
            <div>
                <h2 class="font-bold text-slate-900 text-lg leading-tight truncate max-w-[200px]" id="dashName">Student</h2>
                <p class="text-xs text-slate-500 font-mono mt-0.5" id="dashUSN">Reg. No</p>
            </div>
            <div class="flex gap-2">
                <button onclick="backToFaculty()" id="btnBackFac" class="hidden px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">Back</button>
                <button onclick="logout()" id="btnLogoutStudent" class="w-9 h-9 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100"><i class="fas fa-power-off text-sm"></i></button>
            </div>
        </div>

        <div class="max-w-3xl mx-auto px-4 py-6 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="dash-card border-l-4 border-l-blue-500">
                    <div class="flex justify-between mb-3"><span class="text-xs font-bold text-slate-400">IA - 1</span><span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded font-bold">SEPT</span></div>
                    <div class="text-3xl font-black text-slate-900 mb-1" id="resIA1">--</div>
                    <button onclick="openSplitUp('IA1')" id="btnIA1" class="w-full mt-2 py-2 rounded-lg bg-slate-50 text-slate-600 text-xs font-bold border border-slate-100 hover:bg-slate-100">Split-Up</button>
                </div>
                <div class="dash-card border-l-4 border-l-emerald-500">
                    <div class="flex justify-between mb-3"><span class="text-xs font-bold text-slate-400">IA - 2</span><span class="bg-emerald-50 text-emerald-600 text-[10px] px-2 py-0.5 rounded font-bold">NOV</span></div>
                    <div class="text-3xl font-black text-slate-900 mb-1" id="resIA2">--</div>
                    <button onclick="openSplitUp('IA2')" id="btnIA2" class="w-full mt-2 py-2 rounded-lg bg-slate-50 text-slate-600 text-xs font-bold border border-slate-100 hover:bg-slate-100">Split-Up</button>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-800 text-sm">Other Components</h3></div>
                <div class="p-5 space-y-4">
                    <div class="flex justify-between items-center"><span class="text-sm font-medium text-slate-600">Lab Exam</span><span class="font-mono font-bold text-slate-900" id="resLab">--</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm font-medium text-slate-600">Mini Project</span><span class="font-mono font-bold text-slate-900" id="resProj">--</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm font-medium text-slate-600">Attendance</span><span class="font-mono font-bold text-slate-900" id="resAtt">--</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ENTRY FORM -->
    <div id="viewEntry" class="hidden-section min-h-screen bg-white pb-24">
        <div class="bg-white/90 backdrop-blur-md border-b sticky top-0 z-40 px-4 py-3 flex items-center shadow-sm">
            <button onclick="showDashboard()" class="w-10 h-10 rounded-full bg-slate-50 text-slate-600 flex items-center justify-center mr-3 hover:bg-slate-100">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div>
                <h2 class="font-bold text-slate-900 text-base" id="entryTitle">IA Split-Up</h2>
                <p class="text-xs text-slate-500">Enter Question-wise Marks</p>
            </div>
        </div>

        <div class="max-w-2xl mx-auto px-4 py-6 space-y-8">
            <div>
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide">PART A</h3>
                    <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg">Max 2 Each</span>
                </div>
                <div class="grid grid-cols-4 gap-3" id="partAContainer"></div>
                <div class="text-right mt-2 text-xs font-bold text-slate-400">Total (Best 5): <span id="partATotal" class="text-slate-900 text-sm">0</span></div>
            </div>
            <div id="partBContainer" class="space-y-6"></div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50">
            <div class="max-w-2xl mx-auto flex justify-between items-center gap-4">
                <div><div class="text-[10px] uppercase font-bold text-slate-400">Entry Total</div><div class="text-2xl font-black text-blue-600 leading-none" id="runningTotal">0</div></div>
                <button onclick="openReview()" class="bg-slate-900 text-white font-bold py-3.5 px-8 rounded-xl shadow-lg hover:bg-slate-800 active:scale-95 transition-all flex-1 max-w-[160px]">Review</button>
            </div>
        </div>
    </div>

    <!-- 5. REVIEW PAGE -->
    <div id="viewReview" class="hidden-section min-h-screen bg-slate-50 pb-24">
        <div class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-4 flex items-center shadow-sm">
            <button onclick="closeReview()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center mr-3 hover:bg-slate-200"><i class="fas fa-arrow-left"></i></button>
            <div><h2 class="font-bold text-slate-900 text-lg">Confirm Marks</h2><p class="text-xs text-slate-500">Verify details before saving</p></div>
        </div>
        <div class="max-w-2xl mx-auto px-4 py-6 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Grand Total Calculated</p>
                <p class="text-5xl font-black text-blue-600" id="reviewTotal">0</p>
                <p class="text-xs text-slate-400 mt-2 font-medium">Part A (Best 5) + Part B (Best of Sets)</p>
            </div>
            <div id="reviewContent" class="space-y-4"></div>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50">
            <div class="max-w-2xl mx-auto flex gap-3">
                <button onclick="closeReview()" class="flex-1 py-3.5 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors">Edit</button>
                <button onclick="submitSplitUp()" id="btnFinalSubmit" class="flex-[2] py-3.5 rounded-xl font-bold text-white bg-blue-600 shadow-lg hover:bg-blue-700 transition-colors">Confirm & Save</button>
            </div>
        </div>
    </div>

    <script>
        // *** PASTE DEPLOYED WEB APP URL HERE ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXTkm7w_Tsqs5nIsDYuJtx9KGW0hns3mS53O-Id-WFN-ytj54Lr3YGXpf9fDXHfcDVlQ/exec"; 

        let session = { role: '', dept: '', usn: '', name: '', dob: '', activeIA: '', splitUpData: null, tempMarks: {}, facultyAccess: [] };

        $(document).ready(function() {
            $('#loginUSN').select2({ placeholder: "Select Register No" });
            const saved = localStorage.getItem('marksPortalSession');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved); session = parsed;
                    if(session.role === 'faculty') {
                        setupFacultyView(session.facultyAccess);
                    } else {
                        $('#dashName').text(session.name); $('#dashUSN').text(session.usn);
                        if(session.officialMarks) renderDashboardMarks(session.officialMarks);
                        updateDashButtons(); $('#viewLogin').hide(); $('#viewDashboard').show().addClass('fade-enter-active');
                    }
                } catch(e) { localStorage.removeItem('marksPortalSession'); populateUSN(); }
            } else { populateUSN(); }
        });

        function switchTab(tab) {
            if(tab === 'student') { $('#formStudent').removeClass('hidden'); $('#formFaculty').addClass('hidden'); $('#tabStudent').addClass('text-blue-600 border-blue-600').removeClass('text-slate-400'); $('#tabFaculty').removeClass('text-blue-600 border-blue-600').addClass('text-slate-400'); }
            else { $('#formStudent').addClass('hidden'); $('#formFaculty').removeClass('hidden'); $('#tabFaculty').addClass('text-blue-600 border-blue-600').removeClass('text-slate-400'); $('#tabStudent').removeClass('text-blue-600 border-blue-600').addClass('text-slate-400'); }
        }

        async function populateUSN() {
            if(!GOOGLE_SCRIPT_URL) return;
            const dept = $('input[name="loginDept"]:checked').val();
            const $select = $('#loginUSN'); $select.empty().append('<option value="">Loading...</option>').prop('disabled', true);
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentList&dept=${dept}`);
                const data = await res.json();
                $select.empty().append('<option value="">Select Register No</option>');
                if (data.status === 'success' && data.students) { data.students.forEach(s => $select.append(new Option(`${s.id} - ${s.name}`, s.id))); $select.prop('disabled', false); }
            } catch(e) { console.error(e); } $select.trigger('change');
        }

        // FACULTY
        async function handleFacultyLogin(e) {
            e.preventDefault();
            const user = $('#facUser').val();
            const pass = $('#facPass').val();
            
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=facultyLogin&user=${user}&pass=${pass}`);
                const data = await res.json();
                
                if(data.status === 'error') { alert(data.message); return; }
                
                const access = data.access.split(',').map(d => d.trim());
                session.role = 'faculty'; session.facultyAccess = access;
                localStorage.setItem('marksPortalSession', JSON.stringify(session));
                setupFacultyView(access);
            } catch(e) { alert("Login failed"); }
        }

        function setupFacultyView(access) {
            const $sel = $('#facDeptSelect');
            $sel.empty();
            access.forEach(d => $sel.append(new Option(d, d)));
            loadBatchData();
        }

        async function loadBatchData() {
            const dept = $('#facDeptSelect').val();
            if(!dept) return; // Should not happen if access list is populated
            
            $('#viewLogin').hide(); $('#viewFacultyDash').show();
            $('#facTableBody').html('<tr><td colspan="12" class="text-center py-8">Loading...</td></tr>');

            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getBatchData&dept=${dept}&facultyAuth=true`);
                const data = await res.json();
                if(data.status === 'error') { alert(data.message); logout(); return; }
                
                // Sort by Register Number
                data.data.sort((a, b) => a.usn.localeCompare(b.usn));
                
                const rows = data.data.map((s, idx) => {
                    const ia1 = parseFloat(s.ia1_raw) || 0; const ia2 = parseFloat(s.ia2_raw) || 0;
                    const iaAvg = Math.ceil((ia1 + ia2) / 2);
                    const ia20 = Math.ceil((iaAvg / 50) * 20);
                    const oa = parseFloat(s.proj||0);
                    const lab = parseFloat(s.lab||0);
                    const cp = parseFloat(s.cp||0);
                    const total40 = ia20 + lab + oa + cp;
                    
                    const status1 = s.ia1_submitted ? 'status-green' : 'status-gray';
                    const status2 = s.ia2_submitted ? 'status-green' : 'status-gray';
                    
                    // Updated Red Highlight Logic (<40% of max)
                    const low = (val, max) => val < (max * 0.4) ? 'low-mark' : '';
                    
                    return `<tr class="cursor-pointer" onclick="facultyEditStudent('${s.usn}')">
                        <td class="font-bold text-slate-400 text-xs">${idx+1}</td>
                        <td class="font-mono text-xs font-bold text-slate-600">${s.usn}</td>
                        <td class="font-bold text-slate-800 text-xs truncate max-w-[150px]">${s.name}</td>
                        <td class="font-bold text-slate-800 ${low(ia1, 50)}"><span class="status-dot ${status1}">*</span> ${s.ia1_raw}</td>
                        <td class="font-bold text-slate-800 ${low(ia2, 50)}"><span class="status-dot ${status2}">*</span> ${s.ia2_raw}</td>
                        <td class="text-slate-600 font-medium ${low(iaAvg, 50)}">${iaAvg}</td>
                        <td class="text-slate-600 font-medium ${low(ia20, 20)}">${ia20}</td>
                        <td class="text-slate-500 ${low(oa, 5)}">${s.proj||'-'}</td>
                        <td class="text-slate-500 ${low(lab, 10)}">${s.lab||'-'}</td>
                        <td class="text-slate-500 ${low(cp, 5)}">${s.cp||'-'}</td>
                        <td class="font-bold text-blue-600 ${low(total40, 40)}">${total40}</td>
                        <td><button class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-bold hover:bg-blue-50 hover:text-blue-600">EDIT</button></td>
                    </tr>`;
                }).join('');
                $('#facTableBody').html(rows);
            } catch(e) { alert("Error loading"); logout(); }
        }

        async function facultyEditStudent(usn) {
            try {
                const dept = $('#facDeptSelect').val();
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&usn=${usn}&dept=${dept}&facultyAuth=true`);
                const data = await res.json();
                session.usn = usn; session.name = data.studentName; session.dept = dept;
                session.splitUpData = data.splitUpData; session.officialMarks = data.results;
                $('#viewFacultyDash').hide(); $('#btnBackFac').removeClass('hidden'); $('#btnLogoutStudent').addClass('hidden');
                $('#dashName').text(session.name); $('#dashUSN').text(session.usn);
                renderDashboardMarks(data.results); updateDashButtons(); $('#viewDashboard').show();
            } catch(e) { alert("Error"); }
        }

        function backToFaculty() {
            $('#viewDashboard').hide(); $('#viewEntry').hide(); $('#viewFacultyDash').show();
            $('#btnBackFac').addClass('hidden'); $('#btnLogoutStudent').removeClass('hidden');
            loadBatchData();
        }

        // STUDENT
        async function handleLogin(e) {
            e.preventDefault();
            const usn = $('#loginUSN').val(), dob = $('#loginDOB').val(), dept = $('input[name="loginDept"]:checked').val();
            if(!usn || !dob) { alert("Fill all fields"); return; }
            $('#btnLogin').text('Authenticating...').prop('disabled', true);
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&usn=${usn}&dob=${dob}&dept=${dept}`);
                const data = await res.json();
                if(data.status === 'error') { alert(data.message); $('#btnLogin').text('View Results').prop('disabled', false); return; }
                session = { role: 'student', dept, usn, name: data.studentName, dob, splitUpData: data.splitUpData, officialMarks: data.results, tempMarks: {} };
                localStorage.setItem('marksPortalSession', JSON.stringify(session));
                $('#dashName').text(session.name); $('#dashUSN').text(session.usn);
                renderDashboardMarks(data.results); updateDashButtons();
                $('#viewLogin').hide(); $('#viewDashboard').show().addClass('fade-enter-active');
            } catch(e) { alert("Error"); } finally { $('#btnLogin').text('View Results').prop('disabled', false); }
        }

        function renderDashboardMarks(results) {
            const fmt = (val) => (val === 'AB' || val === 'ab') ? `<span class="mark-ab">AB</span>` : (val || "--");
            $('#resIA1').html(fmt(results.ia.IA1)); $('#resIA2').html(fmt(results.ia.IA2));
            $('#resLab').html(fmt(results.others.Lab)); $('#resProj').html(fmt(results.others.Project)); $('#resAtt').html(fmt(results.others.Attendance));
        }

        function updateDashButtons() {
            const btn1 = $('#btnIA1'), btn2 = $('#btnIA2');
            const styleDone = 'bg-green-50 text-green-700 border-green-200', styleDo = 'bg-slate-50 text-slate-600 border-slate-100';
            if(session.splitUpData && session.splitUpData['IA1']) btn1.text('Edit Split-Up').removeClass(styleDo).addClass(styleDone);
            else btn1.text('Enter Split-Up').removeClass(styleDone).addClass(styleDo);
            if(session.splitUpData && session.splitUpData['IA2']) btn2.text('Edit Split-Up').removeClass(styleDo).addClass(styleDone);
            else btn2.text('Enter Split-Up').removeClass(styleDone).addClass(styleDo);
        }

        function openSplitUp(ia) {
            session.activeIA = ia;
            $('#entryTitle').text(`${ia} Split-Up`);
            $('#viewDashboard').hide(); $('#viewEntry').show(); window.scrollTo(0,0);
            renderForm();
            const saved = session.splitUpData && session.splitUpData[ia] ? session.splitUpData[ia] : {};
            const temp = session.tempMarks && session.tempMarks[ia] ? session.tempMarks[ia] : {};
            const marks = { ...saved, ...temp };
            for (const [k, v] of Object.entries(marks)) {
                const inp = document.querySelector(`input[data-key="${k}"]`);
                if(inp) { inp.value = v; validateInput(inp, inp.max, false); }
            }
            updateCalc();
        }

        function renderForm() {
            $('#partAContainer').empty();
            for(let i=1; i<=7; i++) {
                $('#partAContainer').append(`<div><label class="block text-center text-[10px] font-bold text-slate-400 mb-1 uppercase">Q${i}</label><input type="number" inputmode="decimal" min="0" max="2" step="0.5" class="input-bubble w-full h-14" oninput="handleInput(this, 2)" data-key="Q${i}" data-section="A"></div>`);
            }
            const subs = session.activeIA === 'IA1' ? ['a(i)', 'a(ii)', 'b(i)', 'b(ii)'] : ['a', 'b'];
            const max = session.activeIA === 'IA1' ? 5 : 10;
            const renderQ = (q) => {
                let h = `<div class="bg-white border border-slate-200 rounded-2xl p-5 mb-4 shadow-sm"><div class="font-bold text-2xl text-slate-800 mb-4 pb-2 border-b border-slate-100">${q}</div><div>`;
                subs.forEach(s => { h += `<div class="part-b-row"><span class="text-base font-bold text-slate-500 font-mono">${q}${s}</span><input type="number" inputmode="decimal" min="0" max="${max}" step="0.5" placeholder="-" class="input-bubble w-24 h-12" oninput="handleInput(this, ${max})" data-key="${q}${s}" data-group="${q}"></div>`; });
                return h + `</div></div>`;
            };
            $('#partBContainer').html(renderQ('Q8') + renderQ('Q9') + `<div class="h-2"></div>` + renderQ('Q10') + renderQ('Q11'));
        }

        function handleInput(inp, max) {
            validateInput(inp, max);
            if(!session.tempMarks) session.tempMarks = {};
            if(!session.tempMarks[session.activeIA]) session.tempMarks[session.activeIA] = {};
            session.tempMarks[session.activeIA][inp.dataset.key] = inp.value;
            localStorage.setItem('marksPortalSession', JSON.stringify(session));
        }

        function validateInput(inp, max, calc=true) {
            if(parseFloat(inp.value) > max) { inp.value = max; inp.classList.add('error-border'); setTimeout(()=>inp.classList.remove('error-border'),500); }
            if(parseFloat(inp.value) < 0) inp.value = 0;
            if(calc) updateCalc();
        }

        function updateCalc() {
            let aVals = [];
            document.querySelectorAll(`input[data-section="A"]`).forEach(inp => aVals.push({id: inp.dataset.key, val: parseFloat(inp.value)||0}));
            aVals.sort((a,b)=>b.val-a.val);
            let aSum = 0; let top = [];
            for(let i=0; i<5 && i<aVals.length; i++) { aSum+=aVals[i].val; top.push(aVals[i].id); }
            document.querySelectorAll(`input[data-section="A"]`).forEach(inp => {
                if(inp.value !== "" && top.includes(inp.dataset.key)) { inp.style.backgroundColor='#eff6ff'; inp.style.color='#1d4ed8'; }
                else if(inp.value !== "") { inp.style.backgroundColor='#f8fafc'; inp.style.color='#94a3b8'; }
                else inp.removeAttribute('style');
            });
            $('#partATotal').text(aSum);
            let sum = 0; ['Q8','Q9','Q10','Q11'].forEach(q => { let qSum=0; document.querySelectorAll(`input[data-group="${q}"]`).forEach(i=>qSum+=parseFloat(i.value)||0); });
            const getS = (q) => { let s=0; document.querySelectorAll(`input[data-group="${q}"]`).forEach(i=>s+=parseFloat(i.value)||0); return s; };
            const tot = aSum + Math.max(getS('Q8'), getS('Q9')) + Math.max(getS('Q10'), getS('Q11'));
            $('#runningTotal').text(tot);
        }

        function openReview() {
            $('#reviewTotal').text($('#runningTotal').text());
            const content = $('#reviewContent'); content.empty();
            // Part A
            let aVals = []; document.querySelectorAll(`input[data-section="A"]`).forEach(i=>aVals.push({k:i.dataset.key, v:parseFloat(i.value)||0}));
            let sortedA = [...aVals].sort((a,b)=>b.v-a.v); let topA = sortedA.slice(0,5).map(x=>x.k);
            let htmlA = `<div class="bg-white border rounded-xl p-4 shadow-sm mb-4"><div class="flex justify-between font-bold text-sm mb-2 text-slate-800"><span>Part A (Best 5)</span><span>${$('#partATotal').text()}</span></div><div class="grid grid-cols-4 gap-2">`;
            aVals.forEach(x => { const style = topA.includes(x.k) ? 'bg-blue-50 text-blue-700 font-bold border-blue-200' : 'bg-slate-50 text-slate-400 border-transparent'; htmlA += `<div class="text-center p-2 rounded border ${style}"><div class="text-[10px] uppercase">${x.k}</div><div>${x.v}</div></div>`; });
            content.append(htmlA + `</div></div>`);
            // Part B
            const getQDetails = (q) => {
                let rows = ''; let tot = 0;
                document.querySelectorAll(`input[data-group="${q}"]`).forEach(i => {
                    if(i.value > 0) { rows+=`<div class="review-sub-row"><span>${i.dataset.key}</span><span class="review-sub-val">${i.value}</span></div>`; tot+=parseFloat(i.value); }
                });
                return { h: rows || '<div class="text-xs italic text-slate-300">No entry</div>', t: tot };
            };
            const q8=getQDetails('Q8'), q9=getQDetails('Q9'), q10=getQDetails('Q10'), q11=getQDetails('Q11');
            const renderSet = (t, best, qa, da, qb, db) => `
                <div class="bg-white rounded-xl border p-4 shadow-sm mb-4">
                    <div class="flex justify-between font-bold text-sm mb-3 border-b pb-2"><span>${t}</span><span class="text-blue-600 text-lg">${best}</span></div>
                    <div class="space-y-3">
                        <div class="review-group"><div class="review-header"><span>${qa}</span><span>${da.t} ${da.t>=db.t && da.t>0?'<span class="review-best-badge">BEST</span>':''}</span></div>${da.h}</div>
                        <div class="review-group !mb-0"><div class="review-header"><span>${qb}</span><span>${db.t} ${db.t>da.t?'<span class="review-best-badge">BEST</span>':''}</span></div>${db.h}</div>
                    </div></div>`;
            content.append(renderSet("Set 1", Math.max(q8.t, q9.t), "Q8", q8, "Q9", q9));
            content.append(renderSet("Set 2", Math.max(q10.t, q11.t), "Q10", q10, "Q11", q11));
            $('#viewEntry').hide(); $('#viewReview').show(); window.scrollTo(0,0);
        }

        function closeReview() { $('#viewReview').hide(); $('#viewEntry').show(); }

        async function submitSplitUp() {
            $('#btnFinalSubmit').text('Saving...').prop('disabled', true);
            const payload = { action: 'submit', config: { dept: session.dept, ia: session.activeIA }, student: { usn: session.usn, name: session.name }, calculatedTotal: $('#runningTotal').text(), marks: {} };
            document.querySelectorAll('input[data-key]').forEach(i => payload.marks[i.dataset.key] = i.value);
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                alert("Saved!");
                if(!session.splitUpData) session.splitUpData={}; session.splitUpData[session.activeIA]=payload.marks;
                if(session.tempMarks[session.activeIA]) delete session.tempMarks[session.activeIA];
                localStorage.setItem('marksPortalSession', JSON.stringify(session));
                if(session.role === 'faculty') backToFaculty(); else { updateDashButtons(); closeReview(); showDashboard(); }
            } catch(e) { alert("Error"); } finally { $('#btnFinalSubmit').text('Confirm & Save').prop('disabled', false); }
        }
        function logout() { localStorage.removeItem('marksPortalSession'); location.reload(); }
    </script>
</body>
</html>
